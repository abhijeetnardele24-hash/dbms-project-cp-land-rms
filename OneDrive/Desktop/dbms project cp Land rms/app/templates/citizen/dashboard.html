{% extends "base.html" %}
{% block title %}My Dashboard - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-radius: 15px;
        overflow: hidden;
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    .stat-icon {
        font-size: 3rem;
        opacity: 0.2;
        position: absolute;
        right: 15px;
        top: 15px;
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
    .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .gradient-success {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .gradient-warning {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    .gradient-info {
        background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
    }
</style>
{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body text-white p-4">
                <h2 class="mb-2"><i class="fas fa-tachometer-alt"></i> Welcome, {{ current_user.full_name }}!</h2>
                <p class="mb-0"><i class="fas fa-calendar"></i> Today: {{ current_date.strftime('%B %d, %Y') }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-white gradient-primary dashboard-card border-0 shadow">
            <div class="card-body position-relative">
                <i class="fas fa-home stat-icon"></i>
                <h6 class="card-title mb-2"><i class="fas fa-home"></i> My Properties</h6>
                <h1 class="mb-0 display-4 fw-bold">{{ my_properties_count }}</h1>
                <small class="mt-2 d-block">{{ approved_properties }} Approved • {{ pending_properties }} Pending</small>
                <a href="{{ url_for('citizen.my_properties') }}" class="btn btn-light btn-sm mt-2">
                    <i class="fas fa-eye"></i> View All
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white gradient-warning dashboard-card border-0 shadow">
            <div class="card-body position-relative">
                <i class="fas fa-exchange-alt stat-icon"></i>
                <h6 class="card-title mb-2"><i class="fas fa-exchange-alt"></i> Mutations</h6>
                <h1 class="mb-0 display-4 fw-bold">{{ pending_mutations + approved_mutations + rejected_mutations }}</h1>
                <small class="mt-2 d-block">{{ approved_mutations }} Approved • {{ pending_mutations }} Pending</small>
                <a href="{{ url_for('citizen.my_mutations') }}" class="btn btn-light btn-sm mt-2">
                    <i class="fas fa-list"></i> View All
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white gradient-success dashboard-card border-0 shadow">
            <div class="card-body position-relative">
                <i class="fas fa-rupee-sign stat-icon"></i>
                <h6 class="card-title mb-2"><i class="fas fa-rupee-sign"></i> Total Paid</h6>
                <h1 class="mb-0 display-3 fw-bold">₹{{ "{:,.0f}".format(total_amount_paid) }}</h1>
                <small class="mt-2 d-block">{{ total_payments }} Transactions</small>
                <a href="{{ url_for('citizen.payments') }}" class="btn btn-light btn-sm mt-2">
                    <i class="fas fa-history"></i> History
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-white gradient-info dashboard-card border-0 shadow">
            <div class="card-body position-relative">
                <i class="fas fa-bell stat-icon"></i>
                <h6 class="card-title mb-2"><i class="fas fa-bell"></i> Notifications</h6>
                <h1 class="mb-0 display-4 fw-bold">{{ recent_notifications|length }}</h1>
                <small class="mt-2 d-block">Recent Updates</small>
                <a href="{{ url_for('citizen.notifications') }}" class="btn btn-light btn-sm mt-2">
                    <i class="fas fa-eye"></i> View All
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('citizen.register_property') }}" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-plus-circle"></i><br>Register Property
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('citizen.make_payment') }}" class="btn btn-success btn-lg w-100">
                            <i class="fas fa-rupee-sign"></i><br>Make Payment
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('citizen.submit_mutation') }}" class="btn btn-info btn-lg w-100">
                            <i class="fas fa-exchange-alt"></i><br>Request Mutation
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('citizen.my_properties') }}" class="btn btn-warning btn-lg w-100">
                            <i class="fas fa-list"></i><br>View Properties
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Property Status Chart -->
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Property Status</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="propertyStatusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Property by Type Chart -->
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-home"></i> Property Types</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="propertyTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mutation Status Chart -->
    <div class="col-md-4 mb-3">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-exchange-alt"></i> Mutation Status</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="mutationStatusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Trend Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-chart-area"></i> Payment Trend (Last 6 Months)</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="paymentTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <!-- Recent Notifications -->
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-bell"></i> Recent Notifications</h5>
                <a href="{{ url_for('citizen.notifications') }}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                {% if recent_notifications %}
                    <div class="list-group list-group-flush">
                        {% for notification in recent_notifications[:5] %}
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ notification.title }}</h6>
                                <small class="text-muted">{{ notification.created_at.strftime('%d %b') }}</small>
                            </div>
                            <p class="mb-1 small">{{ notification.message[:100] }}...</p>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center my-4">
                        <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                        No notifications yet
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Recent Payments -->
    <div class="col-md-6 mb-3">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-receipt"></i> Recent Payments</h5>
                <a href="{{ url_for('citizen.payments') }}" class="btn btn-sm btn-outline-success">View All</a>
            </div>
            <div class="card-body">
                {% if recent_payments %}
                    <div class="list-group list-group-flush">
                        {% for payment in recent_payments[:5] %}
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">₹{{ "{:,.2f}".format(payment.amount) }}</h6>
                                <span class="badge bg-{{ 'success' if payment.status == 'completed' else 'warning' }}">
                                    {{ payment.status|upper }}
                                </span>
                            </div>
                            <p class="mb-1 small">{{ payment.payment_type|replace('_', ' ')|title }}</p>
                            <small class="text-muted">{{ payment.payment_date.strftime('%d %b %Y') }}</small>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center my-4">
                        <i class="fas fa-wallet fa-3x mb-3 d-block"></i>
                        No payments yet
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Property Status Pie Chart
const propertyStatusCtx = document.getElementById('propertyStatusChart').getContext('2d');
const propertyStatusChart = new Chart(propertyStatusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Total Properties', 'Pending', 'Approved'],
        datasets: [{
            data: [{{ my_properties_count }}, {{ pending_properties }}, {{ my_properties_count - pending_properties }}],
            backgroundColor: [
                'rgba(102, 126, 234, 0.8)',
                'rgba(250, 112, 154, 0.8)',
                'rgba(72, 219, 251, 0.8)'
            ],
            borderColor: [
                'rgba(102, 126, 234, 1)',
                'rgba(250, 112, 154, 1)',
                'rgba(72, 219, 251, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed;
                    }
                }
            }
        }
    }
});

// Property Type Doughnut Chart
const propertyTypeCtx = document.getElementById('propertyTypeChart').getContext('2d');
const propertyTypeChart = new Chart(propertyTypeCtx, {
    type: 'doughnut',
    data: {
        labels: [
            {% for row in property_by_type %}
            '{{ row[0] or 'Unknown' }}',
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for row in property_by_type %}
                {{ row[1] }},
                {% endfor %}
            ],
            backgroundColor: [
                'rgba(102, 126, 234, 0.8)',
                'rgba(250, 112, 154, 0.8)',
                'rgba(72, 219, 251, 0.8)',
                'rgba(254, 176, 25, 0.8)',
                'rgba(74, 189, 172, 0.8)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
    }
});

// Mutation Status Chart
const mutationCtx = document.getElementById('mutationStatusChart').getContext('2d');
const mutationChart = new Chart(mutationCtx, {
    type: 'pie',
    data: {
        labels: ['Approved', 'Pending', 'Rejected'],
        datasets: [{
            data: [{{ approved_mutations }}, {{ pending_mutations }}, {{ rejected_mutations }}],
            backgroundColor: [
                'rgba(40, 199, 111, 0.8)',
                'rgba(255, 193, 7, 0.8)',
                'rgba(234, 84, 85, 0.8)'
            ],
            borderWidth: 2
        }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
});

// Payment Trend Area Chart (Last 6 Months)
const paymentTrendCtx = document.getElementById('paymentTrendChart').getContext('2d');
const paymentTrendChart = new Chart(paymentTrendCtx, {
    type: 'line',
    data: {
        labels: [
            {% for row in monthly_payments %}
            '{{ "%02d"|format(row[1]|int) }}/{{ row[0]|int }}',
            {% endfor %}
        ],
        datasets: [{
            label: 'Total Paid (₹)',
            data: [
                {% for row in monthly_payments %}
                {{ row[2] }},
                {% endfor %}
            ],
            backgroundColor: 'rgba(102, 126, 234, 0.2)',
            borderColor: 'rgba(102, 126, 234, 1)',
            fill: true,
            tension: 0.35,
            pointRadius: 4,
            pointHoverRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { callback: (value) => '₹' + value.toLocaleString() }
            }
        }
    }
});
</script>
{% endblock %}
